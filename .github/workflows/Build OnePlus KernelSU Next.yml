name: Build OnePlus13 KernelSU Next (6.6)
on:
  workflow_dispatch:
    inputs:
    
      CPU:
        description: "CPUåˆ†æ”¯"
        required: true
        type: choice
        options:
          - 'sm8750'  # ä¸€åŠ 13åŸºäºsm8750èŠ¯ç‰‡
          - 'sm8650'
          - 'sm8550'
          - 'sm8450'
          - 'sm8475'
          - 'sm7675'
          - 'sm6375'
        default: 'sm8750'  # é»˜è®¤sm8750
        
      FEIL:
        description: "æ‰‹æœºå‹å·"
        required: true
        type: choice
        options:
          - 'oneplus_13'  # æ–°å¢ä¸€åŠ 13é€‰é¡¹
          - 'oneplus_12'
          - 'oneplus_ace3_pro'
          - 'oneplus_ace5'
          - 'oneplus_13r'
          # ä¿ç•™å…¶ä»–å‹å·ä½†é»˜è®¤ä¸€åŠ 13
        default: 'oneplus_13'
        
      CPUD:
        description: "å¤„ç†å™¨ä»£å·"
        required: true
        type: choice
        options:
          - 'sun'  # ä¸€åŠ 13å¤„ç†å™¨ä»£å·sun
          - 'pineapple'
          - 'kalama'
          - 'waipio'
          - 'crow'
          - 'blair'
        default: 'sun'
        
      ANDROID_VERSION:
        description: "å†…æ ¸å®‰å“ç‰ˆæœ¬"
        required: true
        type: choice
        options:
          - 'android15'  # æ–°å¢android15
          - 'android14'
          - 'android13'
          - 'android12'
        default: 'android15'
        
      KERNEL_VERSION:
        description: "å†…æ ¸ç‰ˆæœ¬"
        required: true
        type: choice
        options:
          - '6.6'  # æ–°å¢6.6å†…æ ¸
          - '6.1'
          - '5.15'
          - '5.10'
        default: '6.6'


jobs:
  build:
    name: For oneplus_13 (sm8750/sun/android15/6.6)
    runs-on: ubuntu-latest
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      CCACHE_DIR: /home/runner/.ccache  
      CCACHE_MAXSIZE: 10G  # 6.6å†…æ ¸ç¼–è¯‘éœ€æ›´å¤§ç¼“å­˜


    steps:
      # ====================== ç³»ç»Ÿåˆå§‹åŒ–é˜¶æ®µ ======================
      - name: "ğŸš€ æœ€å¤§åŒ–æ„å»ºç©ºé—´"
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 10240  # å¢åŠ é¢„ç•™ç©ºé—´ï¼ˆ6.6å†…æ ¸æ›´å¤§ï¼‰
          temp-reserve-mb: 5120
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          
      - name: "ğŸ” é…ç½®Gitè´¦æˆ·"
        run: |
          git config --global user.name "oneplus13-builder"
          git config --global user.email "builder@oneplus13.com"


      # ====================== ä¾èµ–ç®¡ç†é˜¶æ®µ ======================
      - name: "ğŸ“¦ å®‰è£…æ„å»ºä¾èµ–"
        run: |
          sudo rm -f /var/lib/apt/lists/lock /var/lib/dpkg/lock
          APT_CACHE_DIR="$HOME/apt-cache"
          mkdir -p "$APT_CACHE_DIR/lists/partial"
          sudo apt -o Dir::Cache="$APT_CACHE_DIR" update -qq
          # 6.6å†…æ ¸ç¼–è¯‘éœ€é¢å¤–ä¾èµ–
          sudo DEBIAN_FRONTEND=noninteractive apt -o Dir::Cache="$APT_CACHE_DIR" install -yq --no-install-recommends \
            python3 git curl ccache libelf-dev \
            build-essential flex bison libssl-dev \
            libncurses-dev liblz4-tool zlib1g-dev \
            libxml2-utils rsync unzip llvm clang lld \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu  # æ–°å¢äº¤å‰ç¼–è¯‘å™¨


      # ====================== ç¼“å­˜ç®¡ç†é˜¶æ®µ ======================
      - name: "ğŸ’¾ æ¢å¤ccacheç¼“å­˜"
        uses: actions/cache@v3
        with:
          path: /home/runner/.ccache
          key: ccache-oneplus13-sm8750-6.6-android15
          restore-keys: |
            ccache-oneplus13-sm8750-6.6-


      # ====================== æºç å‡†å¤‡é˜¶æ®µ ======================
      - name: "â¬‡ï¸ å…‹éš†ä¸€åŠ 13å†…æ ¸æºç  (sm8750/6.6)"
        run: |
          mkdir kernel_workspace && cd kernel_workspace
          # å…‹éš†å®˜æ–¹sm8750å†…æ ¸æºç ï¼ˆé€‚é…6.6ï¼‰
          git clone https://github.com/OnePlusOSS/android_kernel_oneplus_sm8750.git --depth=1
          cd android_kernel_oneplus_sm8750
          # åˆ‡æ¢åˆ°6.6å†…æ ¸åˆ†æ”¯ï¼ˆå‡è®¾åˆ†æ”¯åä¸ºandroid15-6.6ï¼Œéœ€æ ¹æ®å®é™…ä»“åº“è°ƒæ•´ï¼‰
          git checkout origin/android15-6.6
          # æ¸…ç†ç‰ˆæœ¬å­—ç¬¦ä¸²ä¸­çš„dirtyæ ‡è®°
          sed -i 's/ -dirty//g' scripts/setlocalversion
          sed -i '$i res=$(echo "$res" | sed '\''s/-dirty//g'\'')' scripts/setlocalversion
          sed -i '$s|echo "\$res"|echo "-oneplus13-ksu-next"|' scripts/setlocalversion
          echo "âœ… ä¸€åŠ 13å†…æ ¸æºç å‡†å¤‡å®Œæˆ"


      # ====================== å†…æ ¸å®šåˆ¶é˜¶æ®µ ======================
      - name: "âš¡ é›†æˆKernelSU Next (rifsxdç‰ˆ)"
        run: |
          cd kernel_workspace/android_kernel_oneplus_sm8750
          # ä¸‹è½½å¹¶æ‰§è¡ŒKernelSU Nextå®‰è£…è„šæœ¬ï¼ˆé€‚é…6.6å†…æ ¸ï¼‰
          curl -LSs "https://raw.githubusercontent.com/rifsxd/KernelSU-Next/next/kernel/setup.sh" | bash -s next
          # è·å–KSUç‰ˆæœ¬å·
          KSU_VERSION=$(expr $(git -C KernelSU-Next rev-list --count HEAD) "+" 10200)
          echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
          # æ›´æ–°Makefileä¸­çš„ç‰ˆæœ¬å·
          sed -i "s/DKSU_VERSION=11998/DKSU_VERSION=${KSU_VERSION}/" KernelSU-Next/kernel/Makefile


      - name: "ğŸ”§ é›†æˆSUSFS (é€‚é…6.6/android15)"
        run: |
          cd kernel_workspace
          # å…‹éš†SUSFSè¡¥ä¸ï¼ˆé€‚é…android15-6.6ï¼‰
          git clone https://gitlab.com/simonpunk/susfs4ksu.git -b gki-android15-6.6
          # å…‹éš†é€‚é…è¡¥ä¸
          git clone https://github.com/Xiaomichael/kernel_patches.git -b next-6.6
          
          cd android_kernel_oneplus_sm8750
          # å¤åˆ¶SUSFSè¡¥ä¸åˆ°å†…æ ¸ç›®å½•
          cp ../susfs4ksu/kernel_patches/50_add_susfs_in_gki-android15-6.6.patch ./
          cp ../kernel_patches/next/scope_min_manual_hooks_v1.5.patch ./  # é€‚é…6.6çš„é’©å­è¡¥ä¸
          cp ../kernel_patches/next/0001-kernel-implement-susfs-v1.5.9-KernelSU-Next-v1.0.9.patch ./
          
          # åº”ç”¨è¡¥ä¸
          patch -p1 < 50_add_susfs_in_gki-android15-6.6.patch || echo "SUSFSåŸºç¡€è¡¥ä¸å†²çªï¼Œæ‰‹åŠ¨å¤„ç†"
          patch -p1 < scope_min_manual_hooks_v1.5.patch || echo "é’©å­è¡¥ä¸å†²çªï¼Œæ‰‹åŠ¨å¤„ç†"
          patch -p1 < 0001-kernel-implement-susfs-v1.5.9-KernelSU-Next-v1.0.9.patch || echo "SUSFSé›†æˆè¡¥ä¸å†²çªï¼Œæ‰‹åŠ¨å¤„ç†"
          
          # å¤åˆ¶SUSFSæ–‡ä»¶ç³»ç»Ÿä»£ç 
          cp ../susfs4ksu/kernel_patches/fs/* fs/
          cp ../susfs4ksu/kernel_patches/include/linux/* include/linux/


      - name: "âš™ï¸ é…ç½®å†…æ ¸é€‰é¡¹ (sm8750/6.6/android15)"
        run: |
          cd kernel_workspace/android_kernel_oneplus_sm8750
          # ç”Ÿæˆä¸€åŠ 13é»˜è®¤é…ç½®ï¼ˆåŸºäºsm8750ï¼‰
          make O=out ARCH=arm64 vendor/oneplus/sm8750_defconfig
          
          # å¯ç”¨KernelSUå’ŒSUSFSé…ç½®
          scripts/config --file out/.config \
            -e CONFIG_KSU \
            -e CONFIG_KSU_KPROBES_HOOK \
            -d CONFIG_MODULE_SIG \
            -d CONFIG_MODULE_SIG_STRICT \
            -e CONFIG_KALLSYMS \
            -e CONFIG_KALLSYMS_ALL \
            -e CONFIG_KSU_SUSFS \
            -e CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT \
            -e CONFIG_KSU_SUSFS_SUS_PATH \
            -e CONFIG_KSU_SUSFS_SPOOF_UNAME \
            -e CONFIG_KSU_SUSFS_ENABLE_LOG
          
          # å¯ç”¨BBRç½‘ç»œç®—æ³•
          scripts/config --file out/.config \
            -e CONFIG_TCP_CONG_ADVANCED \
            -e CONFIG_TCP_CONG_BBR \
            -e CONFIG_NET_SCH_FQ \
            -d CONFIG_TCP_CONG_BIC \
            -d CONFIG_TCP_CONG_WESTWOOD


      # ====================== ç¼–è¯‘é˜¶æ®µ ======================
      - name: "ğŸ”¨ ç¼–è¯‘ä¸€åŠ 13å†…æ ¸ (6.6/android15)"
        run: |
          cd kernel_workspace/android_kernel_oneplus_sm8750
          # è®¾ç½®ç¼–è¯‘å·¥å…·é“¾ï¼ˆé€‚é…6.6å†…æ ¸çš„Clangï¼‰
          export PATH="$HOME/clang/bin:$PATH"
          git clone https://github.com/LineageOS/android_prebuilts_clang_kernel_linux-x86_clang-r487747c.git -b main clang --depth=1
          export CC="ccache clang"
          export CLANG_TRIPLE=aarch64-linux-gnu-
          export CROSS_COMPILE=aarch64-linux-android-
          export ARCH=arm64
          
          # ç¼–è¯‘å†…æ ¸ï¼ˆä½¿ç”¨LTOä¼˜åŒ–ï¼‰
          make O=out \
            LLVM=1 \
            LD=ld.lld \
            HOSTLD=ld.lld \
            CONFIG_LTO_CLANG_THIN=y \
            -j$(nproc)
          
          # æ£€æŸ¥ç¼–è¯‘äº§ç‰©
          if [ ! -f "out/arch/arm64/boot/Image.gz" ]; then
            echo "âŒ å†…æ ¸ç¼–è¯‘å¤±è´¥ï¼Œæœªæ‰¾åˆ°Image.gz"
            exit 1
          fi
          echo "âœ… ä¸€åŠ 13å†…æ ¸ç¼–è¯‘å®Œæˆ"


      # ====================== æ‰“åŒ…é˜¶æ®µ ======================
      - name: "ğŸ“¦ æ‰“åŒ…ä¸ºAnyKernel3åˆ·åŒ…"
        run: |
          # å…‹éš†AnyKernel3æ¨¡æ¿ï¼ˆé€‚é…ä¸€åŠ 13ï¼‰
          git clone https://github.com/osm0sis/AnyKernel3 --depth=1
          cd AnyKernel3
          # æ›¿æ¢å†…æ ¸é•œåƒ
          cp ../kernel_workspace/android_kernel_oneplus_sm8750/out/arch/arm64/boot/Image.gz ./
          # é€‚é…ä¸€åŠ 13çš„dtb/dtboï¼ˆå¦‚æœ‰ï¼‰
          cp ../kernel_workspace/android_kernel_oneplus_sm8750/out/arch/arm64/boot/dts/qcom/sm8750-oneplus13.dtb ./dtb/
          # ä¿®æ”¹AnyKernel3é…ç½®ï¼ˆé€‚é…ä¸€åŠ 13åˆ†åŒºï¼‰
          sed -i "s/device.name1=.*/device.name1=oneplus13/" anykernel.sh
          sed -i "s/kernel.string=.*/kernel.string=OnePlus13 KernelSU Next 6.6/" anykernel.sh
          sed -i "s/build.date=.*/build.date=$(date +%Y-%m-%d)/" anykernel.sh
          cd ..


      # ====================== ä¸Šä¼ é˜¶æ®µ ======================
      - name: "ğŸ“¤ ä¸Šä¼ ç¼–è¯‘äº§ç‰©"
        uses: actions/upload-artifact@v4
        with:
          name: OnePlus13-KernelSU-Next-sun-sm8750-6.6-android15-v${{ env.KSUVER }}
          path: ./AnyKernel3/*
